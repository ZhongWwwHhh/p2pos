name: Build NGINX with HTTP/3 (QUIC) support

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y \
          build-essential \
          libpcre3 \
          libpcre3-dev \
          zlib1g \
          zlib1g-dev \
          libssl-dev \
          libaio-dev \
          git \
          curl

    - name: Clone NGINX source
      run: git clone --branch stable-1.26 https://github.com/nginx/nginx.git

    - name: Clone BoringSSL
      run: |
        git clone https://boringssl.googlesource.com/boringssl
        cd boringssl
        mkdir build
        cd build
        cmake ..
        make

    - name: Configure NGINX with HTTP/3 (QUIC) support
      run: |
        cd nginx
        ./auto/configure \
          --with-compat \
          --with-file-aio \
          --with-threads \
          --with-http_addition_module \
          --with-http_auth_request_module \
          --with-http_dav_module \
          --with-http_flv_module \
          --with-http_gunzip_module \
          --with-http_gzip_static_module \
          --with-http_mp4_module \
          --with-http_random_index_module \
          --with-http_realip_module \
          --with-http_secure_link_module \
          --with-http_slice_module \
          --with-http_ssl_module \
          --with-http_stub_status_module \
          --with-http_sub_module \
          --with-http_v2_module \
          --with-http_v3_module \
          --with-mail \
          --with-mail_ssl_module \
          --with-stream \
          --with-stream_realip_module \
          --with-stream_ssl_module \
          --with-stream_ssl_preread_module \
          --with-debug \
          --with-cc-opt="-I../boringssl/include" \
          --with-ld-opt="-L../boringssl/build/ssl -L../boringssl/build/crypto"

    - name: Build NGINX
      run: |
        cd nginx
        make

    - name: Archive build artifacts
      uses: actions/upload-artifact@v2
      with:
        name: nginx-build
        path: nginx/objs/nginx